<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>DRIVER MACCA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary: #2ec4b6; --secondary: #2b2d42; --bg: #f4f7f6; --orange: #ff9f1c; --red: #ef233c; --blue: #3a86ff; --dark-green: #1b5e20; --light-green: #e8f5e9; }
        body { font-family: 'Poppins', sans-serif; margin: 0; background: var(--bg); color: var(--secondary); padding-bottom: 30px; }
        .navbar { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; }
        
        .form-card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        input { width: 100%; padding: 14px; border-radius: 12px; border: 1.5px solid #eee; font-family: inherit; outline: none; box-sizing: border-box; margin-bottom: 10px; font-size: 1rem; text-align: center; font-weight: bold; color: var(--primary); }
        
        .section-title { font-size: 0.9rem; font-weight: 700; color: #888; margin: 20px 0 10px 5px; display: flex; align-items: center; gap: 8px; }
        
        .order-card { background: white; padding: 15px; border-radius: 15px; margin-bottom: 12px; border-left: 5px solid #ddd; box-shadow: 0 3px 10px rgba(0,0,0,0.03); }
        .order-card.ready { border-left-color: var(--orange); }
        .order-card.onprogress { border-left-color: var(--primary); background: #f0fdfa; }

        .btn-action { width: 100%; margin-top: 12px; padding: 12px; border-radius: 10px; border: none; color: white; font-weight: bold; cursor: pointer; font-family: inherit; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-grab { background: var(--orange); }
        .btn-done { background: var(--primary); }
        .btn-wa { background: #25d366; text-decoration: none; font-size: 0.8rem; padding: 8px 15px; border-radius: 8px; color: white; display: inline-flex; align-items: center; gap: 5px; margin-top: 10px; }

        .status-container { display: flex; justify-content: center; margin-top: 10px; }
        .otw-label { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; background: var(--light-green); color: var(--dark-green); border: 1.5px solid var(--primary); }

        .motor-anim { animation: moveMotor 2s infinite linear; font-size: 1.1rem; }
        @keyframes moveMotor { 0% { transform: translateX(-10px); opacity: 0; } 50% { transform: translateX(0); opacity: 1; } 100% { transform: translateX(10px); opacity: 0; } }
        
        .time-info { font-size: 0.65rem; color: #aaa; display: block; margin-top: 2px; }
        .empty-state { text-align: center; padding: 40px 20px; color: #ccc; }
        .empty-state i { font-size: 3rem; margin-bottom: 10px; display: block; }
    </style>
</head>
<body>
    <div class="navbar"><h3>DRIVER MACCA</h3><button onclick="location.reload()" style="background:none;border:none;color:white;"><i class="fas fa-sync-alt"></i></button></div>
    
    <div class="container">
        <div class="form-card">
            <div style="font-size: 0.7rem; color: #aaa; margin-bottom: 5px; text-align: center;">NAMA DRIVER</div>
            <input type="text" id="driverName" placeholder="Masukkan Nama Anda..." oninput="saveName()">
        </div>

        <div class="section-title"><i class="fas fa-box-open"></i> PESANAN TERSEDIA</div>
        <div id="available-list"></div>

        <div class="section-title"><i class="fas fa-motorcycle"></i> TUGAS SAYA</div>
        <div id="my-task-list"></div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBjEI1iiOjfrpyaZzEntRCGuiiorgxol0", databaseURL: "https://lesehan-macca-new-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Load saved driver name
        document.getElementById('driverName').value = localStorage.getItem('macca_driver') || '';

        function saveName() {
            localStorage.setItem('macca_driver', document.getElementById('driverName').value);
        }

        function formatWaktu(ts) {
            const d = new Date(ts);
            return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }

        function ambilPesanan(k) {
            const dName = document.getElementById('driverName').value;
            if(!dName) return Swal.fire('Oops!', 'Isi nama driver dulu!', 'warning');

            Swal.fire({
                title: 'Ambil Pesanan?',
                text: "Pastikan Anda siap mengantar sekarang",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#ff9f1c',
                confirmButtonText: 'Ya, Ambil!'
            }).then((res) => {
                if(res.isConfirmed) {
                    db.ref('orders/' + k).update({ status: 'onprogress', driver: dName })
                    .then(() => Swal.fire('Berhasil!', 'Silakan berangkat', 'success'));
                }
            });
        }

        function selesaikanPesanan(k) {
            Swal.fire({
                title: 'Sudah Sampai?',
                text: "Konfirmasi jika pesanan sudah diterima pelanggan",
                icon: 'success',
                showCancelButton: true,
                confirmButtonColor: '#2ec4b6',
                confirmButtonText: 'Ya, Selesai!'
            }).then((res) => {
                if(res.isConfirmed) {
                    db.ref('orders/' + k).update({ status: 'delivered' })
                    .then(() => Swal.fire('Mantap!', 'Tugas selesai', 'success'));
                }
            });
        }

        db.ref('orders').on('value', snap => {
            const avList = document.getElementById('available-list');
            const myTask = document.getElementById('my-task-list');
            avList.innerHTML = myTask.innerHTML = '';
            
            const currentDriver = document.getElementById('driverName').value;
            let hasAvail = false, hasTask = false;

            snap.forEach(child => {
                const o = child.val();
                const k = child.key;
                
                const card = document.createElement('div');
                card.className = `order-card ${o.status}`;
                
                const content = `
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <strong style="font-size:1.1rem;">${o.customer}</strong>
                            <span class="time-info">Masuk jam: ${formatWaktu(o.timestamp)}</span>
                        </div>
                        <a href="https://wa.me/${o.whatsapp}" class="btn-wa"><i class="fab fa-whatsapp"></i> Chat</a>
                    </div>
                `;

                if (o.status === 'ready') {
                    hasAvail = true;
                    card.innerHTML = content + `<button class="btn-action btn-grab" onclick="ambilPesanan('${k}')"><i class="fas fa-hand-holding-heart"></i> AMBIL PESANAN</button>`;
                    avList.prepend(card);
                } 
                else if (o.status === 'onprogress' && o.driver === currentDriver) {
                    hasTask = true;
                    card.innerHTML = content + `
                        <div class="status-container">
                            <div class="otw-label"><i class="fas fa-motorcycle motor-anim"></i> ANDA SEDANG OTW</div>
                        </div>
                        <button class="btn-action btn-done" onclick="selesaikanPesanan('${k}')"><i class="fas fa-check-double"></i> KONFIRMASI SAMPAI</button>
                    `;
                    myTask.prepend(card);
                }
            });

            if(!hasAvail) avList.innerHTML = '<div class="empty-state"><i class="fas fa-coffee"></i>Belum ada pesanan siap antar</div>';
            if(!hasTask) myTask.innerHTML = '<div class="empty-state"><i class="fas fa-clipboard-list"></i>Belum ada tugas diambil</div>';
        });
    </script>
</body>
</html>
